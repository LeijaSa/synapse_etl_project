{
	"name": "createfactlibrarytable",
	"properties": {
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "silverlibrarydataflowparquet",
						"type": "DatasetReference"
					},
					"name": "libraryparquet1"
				},
				{
					"dataset": {
						"referenceName": "silverlibrarydataflowparquet",
						"type": "DatasetReference"
					},
					"name": "libraryparquet2"
				}
			],
			"sinks": [],
			"transformations": [
				{
					"name": "selectkokoelmat"
				},
				{
					"name": "unpivotkokoelmat"
				},
				{
					"name": "selectlainaus"
				},
				{
					"name": "unpivotlainas"
				},
				{
					"name": "renamingrowvaluestomatchcategories"
				},
				{
					"name": "renamingrowvaluestomatchcategories2"
				},
				{
					"name": "joinlainauskokoelmat"
				},
				{
					"name": "select1"
				}
			],
			"scriptLines": [
				"source(output(",
				"          kunta as string,",
				"          vuosi as integer,",
				"          kokoelmat as integer,",
				"          kokoelmat_kirjat_yhteensa as integer,",
				"          kokoelmat_suomenkieliset_kirjat as integer,",
				"          kokoelmat_ruotsinkieliset_kirjat as integer,",
				"          kokoelmat_muunkieliset_kirjat as integer,",
				"          kokoelmat_kaunokirjat_aikuiset as integer,",
				"          kokoelmat_kaunokirjat_lapset as integer,",
				"          kokoelmat_tietokirjat_aikuiset as integer,",
				"          kokoelmat_tietokirjat_lapset as integer,",
				"          kokoelmat_nuotit_ja_partituurit as integer,",
				"          kokoelmat_musiikkiaanitteet as integer,",
				"          kokoelmat_muut_aanitteet as integer,",
				"          kokoelmat_videotallenteet as integer,",
				"          kokoelmat_muut_aineistot as integer,",
				"          kokoelmat_videot as integer,",
				"          kokoelmat_cd_rom_levyt as integer,",
				"          kokoelmat_dvd_ja_blu_ray_levyt as integer,",
				"          kokonaislainaus as integer,",
				"          lainaus_yhteensa as integer,",
				"          lainaus_kirjat_yhteensa as integer,",
				"          lainaus_suomenkieliset_kirjat as integer,",
				"          lainaus_ruotsinkieliset_kirjat as integer,",
				"          lainaus_muunkieliset_kirjat as integer,",
				"          lainaus_kaunokirjat_aikuiset as integer,",
				"          lainaus_kaunokirjat_lapset as integer,",
				"          lainaus_tietokirjat_aikuiset as integer,",
				"          lainaus_tietokirjat_lapset as integer,",
				"          lainaus_nuotit_ja_partituurit as integer,",
				"          lainaus_musiikkiaanitteet as integer,",
				"          lainaus_muut_aanitteet as integer,",
				"          lainaus_celian_aanikirjat_cd_levyina as integer,",
				"          lainaus_videotallenteet as integer,",
				"          lainaus_muut_aineistot as integer,",
				"          lainaus_videot as integer,",
				"          lainaus_cd_rom_levyt as integer,",
				"          lainaus_dvd_ja_blu_ray_levyt as integer,",
				"          toimintakulut_tilastovuonna as decimal(12,2),",
				"          henkilostokulut as decimal(12,2),",
				"          kirjastoaineistokulut as decimal(12,2),",
				"          kirjojen_hankintakulut as decimal(12,2),",
				"          e_aineistokulut as decimal(12,2),",
				"          tilakustannukset as decimal(12,2),",
				"          muut_kulut as decimal(12,2),",
				"          toimintakulut_kuluvan_vuoden_talousarviossa as decimal(12,2)",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     ignoreNoFilesFound: false,",
				"     format: 'parquet') ~> libraryparquet1",
				"source(output(",
				"          kunta as string,",
				"          vuosi as integer,",
				"          kokoelmat as integer,",
				"          kokoelmat_kirjat_yhteensa as integer,",
				"          kokoelmat_suomenkieliset_kirjat as integer,",
				"          kokoelmat_ruotsinkieliset_kirjat as integer,",
				"          kokoelmat_muunkieliset_kirjat as integer,",
				"          kokoelmat_kaunokirjat_aikuiset as integer,",
				"          kokoelmat_kaunokirjat_lapset as integer,",
				"          kokoelmat_tietokirjat_aikuiset as integer,",
				"          kokoelmat_tietokirjat_lapset as integer,",
				"          kokoelmat_nuotit_ja_partituurit as integer,",
				"          kokoelmat_musiikkiaanitteet as integer,",
				"          kokoelmat_muut_aanitteet as integer,",
				"          kokoelmat_videotallenteet as integer,",
				"          kokoelmat_muut_aineistot as integer,",
				"          kokoelmat_videot as integer,",
				"          kokoelmat_cd_rom_levyt as integer,",
				"          kokoelmat_dvd_ja_blu_ray_levyt as integer,",
				"          kokonaislainaus as integer,",
				"          lainaus_yhteensa as integer,",
				"          lainaus_kirjat_yhteensa as integer,",
				"          lainaus_suomenkieliset_kirjat as integer,",
				"          lainaus_ruotsinkieliset_kirjat as integer,",
				"          lainaus_muunkieliset_kirjat as integer,",
				"          lainaus_kaunokirjat_aikuiset as integer,",
				"          lainaus_kaunokirjat_lapset as integer,",
				"          lainaus_tietokirjat_aikuiset as integer,",
				"          lainaus_tietokirjat_lapset as integer,",
				"          lainaus_nuotit_ja_partituurit as integer,",
				"          lainaus_musiikkiaanitteet as integer,",
				"          lainaus_muut_aanitteet as integer,",
				"          lainaus_celian_aanikirjat_cd_levyina as integer,",
				"          lainaus_videotallenteet as integer,",
				"          lainaus_muut_aineistot as integer,",
				"          lainaus_videot as integer,",
				"          lainaus_cd_rom_levyt as integer,",
				"          lainaus_dvd_ja_blu_ray_levyt as integer,",
				"          toimintakulut_tilastovuonna as decimal(12,2),",
				"          henkilostokulut as decimal(12,2),",
				"          kirjastoaineistokulut as decimal(12,2),",
				"          kirjojen_hankintakulut as decimal(12,2),",
				"          e_aineistokulut as decimal(12,2),",
				"          tilakustannukset as decimal(12,2),",
				"          muut_kulut as decimal(12,2),",
				"          toimintakulut_kuluvan_vuoden_talousarviossa as decimal(12,2)",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     ignoreNoFilesFound: false,",
				"     format: 'parquet') ~> libraryparquet2",
				"libraryparquet1 select(mapColumn(",
				"          kunta,",
				"          vuosi,",
				"          {kokoelmat_Suomenkieliset kirjat} = kokoelmat_suomenkieliset_kirjat,",
				"          {kokoelmat_Ruotsinkieliset kirjat} = kokoelmat_ruotsinkieliset_kirjat,",
				"          {kokoelmat_Muunkieliset kirjat} = kokoelmat_muunkieliset_kirjat,",
				"          {kokoelmat_Kaunokirjat, aikuiset} = kokoelmat_kaunokirjat_aikuiset,",
				"          {kokoelmat_Kaunokirjat, lapset} = kokoelmat_kaunokirjat_lapset,",
				"          {kokoelmat_Tietokirjat, aikuiset} = kokoelmat_tietokirjat_aikuiset,",
				"          {kokoelmat_Tietokirjat, lapset} = kokoelmat_tietokirjat_lapset,",
				"          {kokoelmat_Nuotit ja partituurit} = kokoelmat_nuotit_ja_partituurit,",
				"          {kokoelmat_Musiikkiäänitteet} = kokoelmat_musiikkiaanitteet,",
				"          {kokoelmat_Muut äänitteet} = kokoelmat_muut_aanitteet,",
				"          kokoelmat_Videotallenteet = kokoelmat_videotallenteet,",
				"          {kokoelmat_Muut aineistot} = kokoelmat_muut_aineistot,",
				"          kokoelmat_Videot = kokoelmat_videot,",
				"          {kokoelmat_Cd-rom-levyt} = kokoelmat_cd_rom_levyt,",
				"          {kokoelmat_Dvd ja blu-ray-levyt} = kokoelmat_dvd_ja_blu_ray_levyt",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> selectkokoelmat",
				"selectkokoelmat unpivot(output(",
				"          kategoria as string,",
				"          kokoelmat as integer",
				"     ),",
				"     ungroupBy(kunta,",
				"          vuosi),",
				"     lateral: false,",
				"     ignoreNullPivots: false) ~> unpivotkokoelmat",
				"libraryparquet2 select(mapColumn(",
				"          kunta,",
				"          vuosi,",
				"          {lainaus_Suomenkieliset kirjat} = lainaus_suomenkieliset_kirjat,",
				"          {lainaus_Ruotsinkieliset kirjat} = lainaus_ruotsinkieliset_kirjat,",
				"          {lainaus_Muunkieliset kirjat} = lainaus_muunkieliset_kirjat,",
				"          {lainaus_Kaunokirjat, aikuiset} = lainaus_kaunokirjat_aikuiset,",
				"          {lainaus_Kaunokirjat, lapset} = lainaus_kaunokirjat_lapset,",
				"          {lainaus_Tietokirjat, aikuiset} = lainaus_tietokirjat_aikuiset,",
				"          {lainaus_Tietokirjat, lapset} = lainaus_tietokirjat_lapset,",
				"          {lainaus_Nuotit ja partituurit} = lainaus_nuotit_ja_partituurit,",
				"          {lainaus_Musiikkiäänitteet} = lainaus_musiikkiaanitteet,",
				"          {lainaus_Muut äänitteet} = lainaus_muut_aanitteet,",
				"          {lainaus_Celian äänikirjat cd-levyina} = lainaus_celian_aanikirjat_cd_levyina,",
				"          lainaus_Videotallenteet = lainaus_videotallenteet,",
				"          {lainaus_Muut aineistot} = lainaus_muut_aineistot,",
				"          lainaus_Videot = lainaus_videot,",
				"          {lainaus_Cd-rom-levyt} = lainaus_cd_rom_levyt,",
				"          {lainaus_Dvd ja blu-ray-levyt} = lainaus_dvd_ja_blu_ray_levyt",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> selectlainaus",
				"selectlainaus unpivot(output(",
				"          kategoria as string,",
				"          lainaus as integer",
				"     ),",
				"     ungroupBy(kunta,",
				"          vuosi),",
				"     lateral: false,",
				"     ignoreNullPivots: false) ~> unpivotlainas",
				"unpivotkokoelmat derive(kategoria = replace(kategoria, \"kokoelmat_\", \"\")) ~> renamingrowvaluestomatchcategories",
				"unpivotlainas derive(kategoria = replace(kategoria, \"lainaus_\", \"\")) ~> renamingrowvaluestomatchcategories2",
				"renamingrowvaluestomatchcategories, renamingrowvaluestomatchcategories2 join(unpivotkokoelmat@kunta == unpivotlainas@kunta",
				"     && unpivotkokoelmat@vuosi == unpivotlainas@vuosi",
				"     && renamingrowvaluestomatchcategories@kategoria == renamingrowvaluestomatchcategories2@kategoria,",
				"     joinType:'outer',",
				"     matchType:'exact',",
				"     ignoreSpaces: false,",
				"     broadcast: 'auto')~> joinlainauskokoelmat",
				"joinlainauskokoelmat select(mapColumn(",
				"          kunta = unpivotlainas@kunta,",
				"          vuosi = unpivotlainas@vuosi,",
				"          kategoria = renamingrowvaluestomatchcategories2@kategoria,",
				"          kokoelmat,",
				"          lainaus",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> select1"
			]
		}
	}
}